## I/O系统基本概念

### 输入/输出系统

I/O系统中的几个基本概念：

* 外部设备
* 接口
* 输入设备
* 输出设备
* 外存设备

一般来说I/O系统由I/O软件和I/O硬件两部分构成：

* I/O软件：包括驱动程序、用户程序、管理程序等
* I/O硬件：外部设备、设备控制器和接口、I/O总线等。

### I/O控制方式

* 程序查询方式：CPU通过程序不断查询I/O设备是否已经做好准备，从而控制I/O设备与主机交换信息
* 程序中断方式：只在I/O设备准备就绪并向CPU发出终端请求时才予以相应。
* DMA方式：主存和I/O设备之间有一条直接数据通路，当主存和I/O设备交换信息时，无需调用中断服务程序。
* 通道方式：系统中设有通道控制部件，每个通道都挂接若干外设，主机在执行I/O命令时，只需启动有关通道，通道将执行通道程序，从而完成I/O操作。

## 外部设备

### 输入设备

键盘、鼠标

### 输出设备

**显示器**

显示器的主要参数：屏幕大小、分辨率、灰度级、刷新、刷新频率、显示存储器（VRAN）

显示器的分类：

* 阴极射线管CRt显示器
* 液晶显示器LCD
* LED发光二极管显示器

**打印机**

针式打印机、喷墨式打印机、激光打印机

### 外存储器

**磁盘存储器**

* 磁盘设备组成
  * 存储区域
  * 硬盘存储器的组成
    * 磁盘驱动器
    * 磁盘控制器
* 磁记录原理
* 磁盘的性能指标
  * 容量
  * 记录密度
  * 平均存取时间：寻道时间+旋转延迟时间+传输时间
  * 数据传输率
* 磁盘地址
  * 驱动器号+柱面号+盘面号+扇区号
* 磁盘工作过程

磁盘的主要操作是寻址、读盘、写盘。每个操作字都对应一个控制字。硬盘工作时，第一步是取控制字，第二步是执行控制字。

**磁盘阵列RAID**

RAID指的是将多个独立的物理磁盘组成一个独立的逻辑盘，数据在物理盘上分割交叉存储、并行访问，具有更好的存储性能、可靠性、安全性。

共有RAID0-RAID5共6种方案，详见书上。

**光盘存储器**

利用光学原理读写信息的存储器。采用聚焦激光束对盘式介质以非接触方式记录信息。

**固态硬盘**

Flash Memory

## I/O接口

主机和外设之间的交接界面。

### 功能

* 实现主机和外设的通信联络控制，解决主机与外设时需配合问题，协调不同工作速度的外设和主机之间交换信息。
* 进行地址译码和设备选择
* 实现数据缓冲：CPU与外设之间的速度往往不匹配，为消除差异，接口必须设置数据缓冲寄存器，用于数据的暂存。
* 信号格式的转换：主机和外设之间的电平、数据格式都可能存在差异，接口提供转化功能。
* 传送控制命令和状态信息

### 结构





### 类型

从不同角度看，I/O接口可以分为不同的类型：

* 按数据传送方式可分为**并行**（一字节或一个字的所有位同时传送）和**串行**接口（一位一位地传送）
* 按主机访问I/O设备的控制方式可分为**程序查询接口、中断接口、DMA接口**
* 按功能选择的灵活性可分为**可编程接口**和**不可编程接口**

### I/O端口及其编址

I/O端口指的是接口电路中可以被CPU直接访问的寄存器，主要有数据端口、状态端口和控制端口。通常CPU能对**数据端口**执行**读写**操作，对**状态端口**只执行**读**操作，对**控制端口**只能执行**写**操作。

I/O端口的编址方式有：

* **统一编址**：把I/O端口当作存储器的单元进行地址分配。
* **独立编址**：设置专门的I/O指令来访问I/O端口。

## I/O方式（控制方式）

主机与I/O设备之间的**数据传输**可以采用不同的**控制方式**。常用的有以下三种方式，其中前两种更依赖于CPU中程序指令的执行。

### 程序查询方式

信息交换的控制完全由**主机执行程序**实现，该种方式接口中设置一个**数据缓冲寄存器（数据端口）**和一个**设备状态寄存器（状态端口）**。主机进行I/O操作时，先发出询问信号，读取设备状态并根据设备状态决定下一步的操作。

这种方式下，CPU一旦启动I/O，就必须停止现行程序的运行，并在现行程序中插入一段程序。这种方式下**CPU有踏步等待现象**。CPU在信息传送过程中要花费很多时间**查询和等待**，在一段时间内只能和一台外设交换信息，效率大大降低。

### 程序中断方式

现代计算机系统有完善的异常和中断处理系统，CPU的数据通路有相应的**异常和中断的检测和响应**逻辑。外设接口中有中断请求和逻辑控制，操作系统中有响应的中断服务程序。这些硬件和中断服务程序有机结合，共同完成异常和中断的处理过程。

**异常和中断**

* 异常（内部中断）

由CPU内部引起的意外事件，分为**硬故障中断**和**程序性异常**。硬故障中断指的是**硬连线**出现异常引起的，例如电源掉电等；程序性异常指CPU内部因**执行异常指令**而引起的异常事件。

按照发生异常的报告和返回方式的不同，内部异常可分为：故障、自陷、终止。

**故障**指在引起故障的指令启动后、执行结束前被检测到的异常事件。

**自陷**是预先安排的一种异常事件。用于程序调试的断点设置功能就是通过自陷方式实现的。

**终止**指的是指令执行过程中发生了使计算机无法继续运行的硬件故障，程序无法继续执行，只能终止，此时调用中断服务程序来重启系统。

* 外部中断

外部中断指的是来自**CPU外部、与CPU执行指令无关**的事件引起的中断，包括I/O设备发出的I/O中断、外部信号中断，以及各种定时器引起的时钟中断等。外中断在狭义上一般称为中断。

外部中断和内部异常的不同点：缺页或溢出等异常事件由特定指令在执行过程中产生，而中断不与任何指令相关联，也不阻止任何指令的完成；异常的检测由CPU自身完成，不必通过外部的某个信号通知CPU。对于中断，CPU必须通过总线获取**中断源的标志信息**，才能知道哪个外部设备发生了何种中断。

**中断的基本概念**

计算机执行现行程序过程中，出现某些急需处理的异常概况，CPU暂时中止先行程序，转去对这些异常进行处理。处理完毕后CPU又自动返回到现行程序的断点处，继续执行源程序。

**程序中断方式工作流程**

* **中断请求**：中断源是请求CPU中断的设备或事件，一台计算机允许有多个中断源。为了记录中断事件并区分不同的中断源，中观系统需要给每个中断源设置中断请求标记触发器INTR，当其状态为1时表示中断源有请求。
* **中断判优**：中断系统在任一瞬间只能响应一个中断源请求，多个中断源提出请求时要通过中断判优逻辑确定响应哪个中断源的请求。
* **CPU响应中断的条件**：
  * 中断源有中断请求
  * CPU允许中断及开中断
  * 一条指令执行完毕，并且没有更紧迫的任务

* **中断响应**：
  * 关中断：CPU响应中断后，要保护程序的断点和现场信息，在保护过程中CPU不能响应更高级中断源的中断请求
  * 保存断点
  * 引出中断服务子程序：及取出中断服务程序的入口地址并传送给程序计数器PC

* **中断向量**：每个中断都有一个类型号，每个中断类型号对应一个中断服务程序，每个中断服务程序都有一个入口地址，CPU必须找到**入口地址**，即中断向量，把系统中全部中断向量集中存放到**存储器**的某个区域，这个存储区域称为**中断向量表**。

* 中断处理过程
  * **中断隐指令**（硬件自动完成）
    * 关中断
    * 保存断点：压入堆栈或存入主存的特定单元中
    * 引出中断服务程序：硬件向量法（产生的是中断类型号，指出了存放中断向量的地址）或软件查询法
  * **中断服务程序**
    * 保存现场和屏蔽字
    * 开中断（允许更高级中断请求得到响应）
    * 执行中断服务程序（中断请求的目的）
    * 关中断（保证在恢复现场和屏蔽字时不被中断）
    * 恢复现场和屏蔽字
    * 开中断、中断返回

**多重中断和中断屏蔽技术**

CPU在执行中断服务程序的过程中，又出现了新的更高优先级的中断请求，CPU暂停现行，转而去处理新的中断请求，称为多重中断。

中断屏蔽技术主要用于多重中断，CPU要具备多重中断，必须满足：

* 在中断服务程序中提前设置开中断指令
* 优先级别高的中断源有权中断优先级别低的中断源

### DMA方式

DMA方式在**外设与内存**直接开辟了一条直接数据通道，信息传送**不再经过CPU**，降低了CPU在传送数据时的开销。同时也不需要保护、恢复CPU现场等繁琐操作。

这种方式适用于**高速设备大批量数据的传送**，硬件开销较大。DMA方式中，中断仅限于故障和正常传送结束时的处理。

**DMA方式的特点**

**I/O与主机并行**工作，**程序和传送并行**工作。（中断方式中，I/O与主机并行工作，程序和传送串行工作）

* 主存既可以被CPU访问又可以被外设访问
* 数据块传送时，主存地址的确定、传送数据的计数等都由硬件电路直接实现
* 主存中要开辟专用缓冲区
* DMA传送速度快，CPU和外设并行工作，提高了系统效率
* DMA在传送开始前要通过程序进行预处理，结束后要通过中断方式进行后处理

**DMA控制器的组成**

DMA控制器（接口）的主要功能：

* 接收外设发出的DMA请求，并向CPU发送总线请求
* CPU响应此总线请求，发送总线响应信号，接管总线控制权，进入DMA操作周期
* 确定传送数据的主存单元以及长度，并自动修改主存地址计数和传送长度计数
* 规定数据在主存和外设间的传送方向，发送读写等控制信号，执行数据传送操作
* 向CPU报告DMA操作的结束

**DMA的传送方式**

当**I/O设备和CPU同时访问主存**时，可能发生**冲突**，为了有效使用主存，DMA控制器与CPU通常采用以下方式使用主存：

* 停止CPU访存
* 周期挪用。当I/O设备有DMA请求时，会遇到3种情况：
  * 此时CPU不在访存，未发生冲突
  * CPU正在访存，此时必须等待存取周期结束后，CPU再将总线占用权让出
  * I/O和CPU同时请求访存，出现访存冲突。此时CPU要暂时放弃总线控制权。I/O的优先级更高。

* DMA与CPU交替访存。这种方式适合于CPU工作周期比主存存取周期长的情况。

**DMA的传送过程**

* **预处理**：由CPU完成一些必要的准备工作。
* **数据传送**：可以以单字节或字为基本单位，可以以数据块为基本单位。
* **后处理**：DMA控制器向CPU发送中断请求，CPU执行中断服务程序做DMA结束处理。

**DMA方式与中断方式的区别**

* 中断方式是程序的切换，需要保护和恢复现场；而DMA方式除了预处理和后处理，其他时候不占用CPU的任何资源。
* 对中断响应的请求只能发生在**每条指令执行完后**（即指令的执行周期后）；而对DMA请求的响应可以发生在**每个机器周期结束时**（在取值周期、间址周期、执行周期后均可），只要CPU不占用总线就可被响应。
* 中断传送数据过程中需要CPU干预，而DMA传送过程不需要。
* DMA请求的**优先级高于中断请求**
* 中断方式具有对异常事件的处理能力，而DMA方式仅局限于传送数据块的I/O操作

