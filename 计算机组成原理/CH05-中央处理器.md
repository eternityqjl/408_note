数据通路容易考大题。

## CPU的功能和基本结构

### 功能

CPU由**运算器和控制器**组成。控制器负责协调并控制计算机各部件执行程序的指令序列，包括取指令、分析指令、执行指令；运算器是对数据进行加工。

CPU的具体功能：

* 指令控制：程序的顺序控制
* 操作控制：一条指令功能由若干操作信号的组合来实现。CPU管理并产生由内存取出的每条指令的操作信号，把操作信号送往相应部件
* 时间控制：为每条指令按时间顺序提供应用的控制信号
* 数据加工：对数据进行算术或逻辑运算
* 中断处理：对异常情况和特殊请求进行处理

### 基本结构

**运算器**

* 算术逻辑单元ALU
* 暂存寄存器
* 累加寄存器ACC
* 通用寄存器组
* 程序状态字寄存器PSW
* 移位器
* 计数器

**控制器**

* 程序计数器PC：指出下一条指令在主存中的存放地址。PC有自增功能。
* 指令寄存器IR：用于保存当前正在执行的那条指令
* 指令译码器：仅对操作码字段进行译码，向控制器提供特定操作信号
* 存储器地址寄存器MAR
* 存储器数据寄存器MDR
* 时序系统：用于产生各种时序信号。由统一时钟CLOCK分频得到。
* 微操作信号发生器：根据IR和PSW的内容及时序信号，产生控制整个计算机系统所需的各种控制信号，结构有组合逻辑型和存储逻辑型。

## 指令执行过程

### 指令周期

* 指令周期：CPU从主存中取出并执行一条指令的时间
* 机器周期：不同的工作周期，例如取指、间址、执行、中断周期
* 时钟周期（节拍）：CPU操作的最基本单位

每个指令周期内的机器周期数可以不相等；例如无条件转移指令JMP X在执行时不需要访问主存，只包含取址和执行阶段，所以其指令周期只包含取指和执行周期。

间址指令为了取操作数需要先访问一次主存，取出有效地址，然后访问主存，取出操作数，所以还需要包括间址周期。

当CPU采用中断方式实现主机和I/O设备的信息交换时，CPU在每条指令执行结束前都要发中断查询信号，若有中断请求则CPU进入中断响应阶段，又称中断周期。

### 指令周期的数据流

（各周期的详细步骤见书上的图）

根据指令要求依次访问的数据序列。

**取指周期**

根据PC中的内容从主存中取出指令代码并存放在IR中。取指的同时，PC加1

数据流如下：

* PC$\to$MAR$\to$地址总线$\to$主存
* CU发出读命令$\to$控制总线$\to$主存
* 主存$\to$数据总线$\to$MDR$\to$IR
* CU发出控制指令$\to$PC内容加1

**间址周期**

取操作数的有效地址。

数据流如下：

* Ad(IR)（或MDR）$\to$MAR$\to$地址总线$\to$主存
* CU发出读命令$\to$控制总线$\to$主存
* 主存$\to$数据总线$\to$MDR（存放操作数有效地址）

（Ad(IR)指的是存放在IR中的指令字的地址段）

**执行周期**

取操作数，并根据IR中指令字的操作码通过ALU操作产生执行结果。

不同指令的执行周期操作不同，没有统一的数据流向。

**中断周期**

处理中断请求。假设程序断点存入堆栈，并用SP指示栈顶指针，且进栈操作是先修改栈顶指针后存入数据，则数据流如下：

* CU控制将SP减1，SP$\to$MAR$\to$地址总线$\to$主存
* CU发出写命令$\to$控制总线$\to$主存
* PC$\to$MDR$\to$数据总线$\to$主存（程序断点存入主存）
* CU（中断服务程序的入口地址）$\to$PC

### 指令执行方案

**单指令周期**

对所有指令选用**相同的执行时间**来完成，即每条指令都在固定的时间周期内完成，指令之间串行执行。

对于本可以在更短时间内完成的指令，要使用这个较长的周期来完成，会**降低整个系统的运行速度**。

**多指令周期**

对不同类型的指令选用不同的执行步骤来完成。指令之间串行执行。但可以选用**不同个数的时钟周期**来完成不同指令的执行过程，指令需要几个周期就分配几个周期。

**流水线方案**

指令之间可以并行执行，目标是力求在**每个时钟脉冲**周期完成一条指令的执行过程。这种方案通过在每个时钟周期启动一条指令，尽量让多条指令同时运行，但各自处于不同的执行步骤中。

## 数据通路

### 功能

数据在功能部件之间传输的路径称为数据通路。路径上的部件称为**数据通路部件**。数据通路描述了信息从什么地方开始，中间经过哪个寄存器或多路开关，最后传送到哪个寄存器，这些都需要加以控制。

数据通路由控制部件控制，控制部件根据每条指令功能的不同生成对数据通路的控制信号，并正确控制指令的执行流程。

### 基本结构

* CPU内部单总线方式

将所有寄存器的输入和输出端都连接到一条公共通路上，结构简单，但数据传输存在较多冲突，性能较低。

* CPU内部三总线方式

将所有寄存器的输入和输出端都连接到多条公共通路上，能同时在多个总线上传输不同数据，提高效率。

* 专用数据通路方式

根据指令执行过程中的数据和地址的流动方向安排连接线路，避免使用共享的总线，性能较高但硬件量大。

**寄存器间的数据传送**

寄存器之间的数据传送可以通过CPU内部总线完成。

这里以PC寄存器为例：

PC$\rightarrow$Bus

Bus$\rightarrow$MAR

**主存与CPU之间的数据传送**

二者之间的数据传送同样也要借助CPU内部总线完成。

PC$\rightarrow$Bus$\rightarrow$MAR

1$\rightarrow$R（CU发出读命令）

MEM(MAR)$\rightarrow$MDR

MDR$\rightarrow$Bus$\rightarrow$IR

**执行算术或逻辑运算**

ALU内部本身没有存储功能，如果要执行加法运算，相加的两个数必须在ALU的两个输入端同时有效。

## 控制器

### 结构和功能

计算机硬件的主要连接关系：

* 运算器通过数据总线与内存、输入设备、输出设备传送数据
* 输入输出设备与总线相连
* 内存、输入设备、输出设备通过地址总线接收地址信息，从控制总线得到控制信号，通过数据总线与其他部件传送数据。

控制器的主要功能：

* 从主存中取出一条指令，并指出下一条指令在内存中的位置
* 对指令进行译码或测试，并产生相应控制信号
* 指挥并控制CPU、主存、输入输出设备之间的数据流动

根据控制器产生**微操作控制信号**的方式不同，控制器可以分为**硬布线**控制器和**微程序**控制器，两类控制器的PC和IR是相同的，但是确定和表示执行步骤的方法以及给出控制信号的方案不同。

### 硬布线控制器

根据指令的要求、当前的时序以及外部和内部的状态，按时间的顺序发送一系列微操作控制信号。由复杂的组合逻辑门电路和一些触发器构成，又称为组合逻辑控制器。

**硬布线控制单元**





**时序系统及微操作**





**CPU的控制方式**

* 同步控制
* 异步控制：不存在基准时标信号，各部件按照自身固有速度工作，通过应答方式联络。
* 联合控制：介于同步、异步之间的一种折中。

**硬布线控制单元涉及步骤**

* 列出微操作命令的操作时间表
* 进行微操作信号综合，得到逻辑表达式
* 根据逻辑表达式画出微操作命令的逻辑图，并用逻辑门电路实现。

### 微程序控制器

微程序控制器采用存储逻辑实现，即把为操作信号**代码化**，使每条**机器指令**转化成一段**微程序**并存入一个**专门的存储器（控制存储器CM）**中。微操作控制信号由**微指令**（每个微程序包括若干微指令）产生。

**基本概念**

* 微命令和微操作：一个微操作是计算机中最基本的、不可再分解的操作。一条微命令和微操作一一对应。微命令是构成控制序列的最小单位。
* 微指令和微周期：微指令是由若干微命令的集合。
* 主存储器与控制存储器
* 程序与微程序：微程序对用户透明。

**组成和工作过程**





**微指令的编码方式**

* 直接编码
* 字段直接编码
* 字段间接编码





**微指令的地址形成方式**





**微指令的格式**

* 水平型微指令
* 垂直型微指令
* 混合型微指令



**微程序控制单元的设计步骤**







## 指令流水线

### 基本概念

一种并行处理技术。一条指令的执行过程可分解为若干阶段，每个阶段由相应功能部件完成。如果将各个阶段视为相应流水段，则指令的执行过程就构成了一条指令流水线。采用流水线技术只需要增加少量硬件就能把计算机的运算速度提高几倍。

流水线执行方式

多级流水线

**流水线的表示方法**





**流水线方式的特点**









### 分类





### 影响因素

**资源冲突**

多条指令在同一时刻争用同一资源形成的冲突。

**数据冲突**

下一条指令会用到当前指令计算出的结果。

* 写后读
* 读后写
* 写后写

解决方法：



**控制冲突**

在执行转移、调用或返回等指令时会改变PC值，而造成断流，引起控制冒险。





### 性能指标

**流水线的吞吐率**



**流水线的加速比**





**流水线的效率**





### 超标量流水线

**超标量流水线技术**





**超流水线技术**





**超长指令字**



