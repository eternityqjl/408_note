## 网络层的功能

### 异构互联

网络层向上只提供简单灵活、无连接、尽最大努力交付的数据报服务。

网络互连是不同网络通过中间设备相互连接起来，构成更大网络。中继系统分为：

* 物理层：中继器、集线器
* 数据链路层：网桥或交换机
* 网络层：路由器
* 网络层以上：网关

网络互联一般指用路由器进行网络互联和路由选择。

### 路由与转发

路由器一般完成路由选择（确定路径）和分组转发（一个分组到达时采取的动作）两个功能。

### 拥塞控制

流量控制往往是指在发送端和接收端之间的点对点通信量的控制，流量控制是要抑制发送端发送数据的速率，一边接收端来得及接收。而拥塞控制必须确保通信子网能够传送待传送的数据，是一个全局性问题。

通常拥塞控制的方法有：

* 开环控制
* 闭环控制

## 路由算法

### 距离-向量算法D-V

所有结点定期将其整个路由选择表传送给所有与之相邻的结点。路由选择表包含：

* 每条路径的目的地（另一结点）
* 路径的代价（距离）

这种算法的实质是迭代计算一条路由中的站段数或延迟时间，从而得到到达一个目标的最短通路。

### 链路状态路由算法LS

每个参与该算法的结点都有完全的网络拓扑信息。它们执行以下任务：

* 主动测试所有邻接结点的状态
* 定期地将链路状态传播给其他所有结点。典型的链路状态算法是OSPF算法

每当链路状态发生变化时，结点对更新的网络图利用Dijkstra最短路径算法重新计算路由，从单一源除法计算到达所有目的结点的最短路径。

### 层次路由

因特网把路由选择协议划分为两大类：

* 一个自治系统内部所使用的路由选择协议称为内部网关协议IGP
* 自治系统之间使用的路由选择协议称为外部网关协议EGP



## IPv4

### IPv4分组

**IPv4分组格式**

首部固定部分为20B，可选字段长度可变。

* 版本：4b。指IP的版本，广泛使用的是4
* 首部长度：4b。克表示的最大十进制数为15。以4B为单位，最大值为15*4B=60B。最常用的首部长度为20B
* 总长度：16b。首部和数据长度之和，以字节为单位。最大长度为65535B。
* 标识：16b。是一个计数器，每产生一个数据报就加1，并赋值给标识字段。当一个数据报长度超过MTU时，就要分片，此时每个数据报分片都要复制一次标识号，以便重新组装。
* 标志：3b。该字段最低位为MF，MF=1标识后面还有分片，MF=0表示最后一个分片。该字段中间一位为DF，只有DF=0才允许分片。
* 片偏移：13b。指出较长的分组在分片后，某片在原分组中的相对位置。片偏移以8个字节为偏移单位，即每个分片的长度是8B的整数倍。
* 生存时间TTL：8b。数据报在网络中可通过的路由器数的最大值，表示分组在网络中的寿命，确保分组不会在网络中循环。
* 协议：8b。指出分组携带的数据使用何种协议。值为6表示TCP，17表示UDP。
* 首部校验和：16b。只校验分组的首部。
* 源地址字段：4B。
* 目的地址字段：4B。

注意首部长度、总长度、片偏移的基本单位分别为4B、1B、8B。

**IP数据报分片**

当IP数据报的总长度大于链路层MTU时，就需要将IP数据报中的数据分装在两个或多个较小的IP数据报中，这些较小的数据报称为片。

片在目的地网络层被重新组装。目的主机使用IP首部中的**标识、标志和片偏移**字段完成对片的重组。

详细过程和例子见书上。

**网络层转发分组的流程**

见书。

### IPv4地址与NAT

**IPv4地址**

32b，分为A、B、C、D、E五类。



特殊用途IP：

* 主机号全为0表示本网络本身。
* 主机号全为1表示本网络广播地址。
* 12.x.x.x表示环回自检地址，此地址表示任意主机本身。
* 32位全为0，即0.0.0.0表示本网络上的本主机。
* 32位全为1，即255.255.255.255表示整个TCP/IP网络的广播地址，实际使用时等效为本网络的广播地址。



**网络地址转换NAT**

私有IP地址网段：

* A类：1个，10.0.0.0~10.255.255.255
* B类：16个，172.16.0.0~172.31.255.255
* C类：256个，192.168.0.0~192.168.255.255



### 子网划分与子网掩码、CIDR

**子网划分**

划分子网只是把主机号这部分进行再划分，不改变IP地址原来的网络号。

**子网掩码**

为了告诉主机或路由器对一个A、B或C类网络进行了子网划分，用子网掩码表示对原网络中主机号的借位。

**无分类域间路由选择CIDR**

使用子网掩码划分的具体网络，消除了A、B、C类网络的概念。

### ARP、DHCP与ICMP

**IP与硬件地址**

IP分组通过多次路由转发到达目标网络后，改为在目标LAN中通过数据链路层的MAC地址以广播方式寻址。

在局域网的数据链路层，只能看见MAC帧。而通过路由器转发IP分组时，此IP分组在每个网络中都被路由器解封装和重新封装。因此IP数据报在被路由器转发时，其数据链路层所使用的MAC地址是不断改变的，这也决定了无法使用MAC地址跨网络通信。

**地址解析协议ARP**

完成从IP地址到MAC地址的映射。每台主机上都有一个ARP高速缓存，用来存放**局域网内各主机和路由器到MAC地址的映射表**，称为**ARP表**。

ARP表工作在网络层。用来解决同一个局域网上的主机或路由器的IP地址和硬件地址的映射问题。

ARP的四种典型情况如下：

* 发送方是主机，要把IP数据包发送到本网络上的另一台主机。

**动态主机配置协议DHCP**

DHCP是**应用层协议**，基于**UDP**。

该协议用于给主机动态地分配IP地址，提供了即插即用的联网机制。

工作原理：使用客户/服务器模式。需要IP的主机在启用时向DHCP服务器**广播发送发现报文**，这时主机成为DHCP客户。本地网络上所有主机都能收到此广播报文，**但只有DHCP服务器才能回答该报文**。DHCP服务器先从其数据库中找到该计算机的配置信息，若找到，则返回找到的信息。若找不到则从IP池中取一个地址分配给该计算机。

**网际控制报文协议ICMP**

在**网络层**采用该协议来让主机或路由器**报告差错和异常情况**。

ICMP报文作为IP层数据报的数据，加上数据报的首部，组成IP数据报发送出去。

* ICMP差错报文（用于目的主机或到目的主机路径上的路由器向源主机报告差错和异常）
  * 终点不可达
  * 源点抑制
  * 时间超过
  * 参数问题
  * 改变路由（重定向）

* ICMP询问报文
  * 回送请求和回答报文
  * 时间戳请求和回答报文
  * 地址掩码请求和回答报文
  * 路由器询问和通告报文

ICMP最常用的应用是分组网间探测**PING和Traceroute**。



## IPv6

### 主要特点

* 地址增加到118位
* 扩展的地址层次结构
* 灵活的首部格式
* 改进的选项
* 支持资源预分配

### IPv6地址

地址的表示方法为：每4位用一个十六进制数表示，并用冒号分隔每16位。

一种缩写表示法：当16位域的开头有一些0时可以省略，但在域中至少有一个数字。

IPv6的多级体系：第一级：公共拓扑；第二级：单个场点；第三级：单个网络接口。

## 路由协议

### 自治系统

自治系统（AS）：单一技术管理下的一组路由器。这些路由器使用同一种AS内部的路由选择协议。

一个自治系统内的所有网络都由同一个单位管辖，一个自治系统内的所有路由器都是连通的。



### 域内路由与域间路由

**内部网关协议IGP**

在一个自治系统内部使用的路由选择协议，使用最多的是RIP和OSPF。

**外部网关协议EGP**

源站和目的站处于不同自治系统中时使用一种协议将信息从一个自治系统传送到另一个自治系统。使用最多的是BGP-4.

### 路由信息协议（RIP）

分布式的基于**距离向量**的路由选择协议。是内部网关协议中最先得到应用的。

**RIP规定**：

* 网络中每个路由器都要维护其从自身到其他每个目的网络的距离记录
* 距离也称跳数
* RIP认为好的路由就是跳数少的路径
* RIP允许一条路径最多包含15个路由器，即最多允许15跳。所以距离等于16时表示不可达
* RIP默认在任意两个使用RIP的路由器之间每30s广播一次RIP路由更新信息

**RIP的特点**

* 仅与相邻路由器交换信息
* 交换的是路由表
* 按固定时间间隔30s交换信息

**距离向量算法**



RIP限制了网络规模，能使用的最大距离位15.网络出现故障时会出现慢收敛。

RIP是应用层协议，使用UDP传送数据。



### 开放最短路径优先（OSPF）协议

使用分布式链路状态路由算法。

* OSPF向**本自治系统内所有路由器**发送信息，使用的是泛洪法。

* 发送的信息是与本路由器相邻的所有路由器的链路状态。而RIP发送的是所有信息。
* 只有当链路发生变化时，路由器采用洪泛法向所有路由器发送信息。

OSPF是网络层协议，直接用IP数据报传送，IP数据报首部的协议字段为89.

**OSPF的工作原理**

每个路由器根据整个网络的拓扑结构使用Dijkstra最短路径算法计算从自己到各目的网络的最优路径，构造新路由表。

**OSPF的五种分组类型**

* 问候分组：发现和维持邻站的可达性
* 数据库描述分组：向邻站给出自己的链路状态数据库中的所有链路状态项目的摘要信息。
* 链路状态请求分组：向对方请求发送某些链路状态项目的详细信息
* 链路状态更新分组：用洪泛法对全网更新链路状态
* 链路状态确认分组：对链路更新分组的确认

网络运行过程中，只有一个路由器的链路状态发生变化，该路由器就要使用链路状态更新分组，向全网更新链路状态。

为保证链路状态数据库与全网的状态保持一致，

### 边界网关协议（BGP）

* BGP交换路由信息的结点个数很少
* 每个AS中的边界路由器数量很少，这使得姿势系统之间的路由选择不过分复杂。
* BGP支持CIDR，所以其路由表包括目的网络前缀、下一跳路由器以及到达该目的网络所经过的各AS的序列。

BGP共使用4种报文：

* 打开报文：用来与相邻边界路由器建立关系
* 更新报文：用来发送某一路由的信息
* 保活报文：用来确认打开报文并周期性地正式邻站关系
* 通知报文：用来发送检测到的差错

BGP是应用层协议，基于TCP







## IP组播

### 组播概念

让源计算机一次发送的单个分组可以抵达一个组地址标识的若干目标主机，并被其正确接收。

组播仅用于UDP。

IP组播也是用组播组的概念，每个组有一个特别分配的地址，这些地址在D类地址空间中分配。

主机使用称为IGMP（因特网组管理协议）的协议加入组播组。使用该协议通知本地网络上的路由器关于要接收发送给某个组播组的分组的愿望。

主机组播是仅发送一份数据，只有数据在出现分岔时才将分组复制后继续转发。这样减轻了网络和发送者的负担。

### IP组播地址

组播数据报使用D类IP作为目标IP，首部种协议字段的值为2，表明使用IGMP协议。



### IGMP与组播路由算法







## 移动IP







## 网络层设备

