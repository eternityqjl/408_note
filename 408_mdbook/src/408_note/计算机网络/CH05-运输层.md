## 传输层提供的服务

### 传输层功能

* 应用进程之间的逻辑通信
* 复用和分用

### 传输层的寻址与端口





### 无连接服务和面向连接服务





## UDP

### UDP数据报

**概述**

UDP的优点：

* 无需建立连接
* 无连接状态
* 分组首部开销小
* 应用层能更好地控制发送的数据和发送时间。UDP没有拥塞控制。
* UDP支持一对一、一对多、多对多的交互通信。

UDP常用于一次性传输较少数据的网络应用。



**首部格式**

UDP的首部长度为8B。由4个字段组成，每个字段的长度都是2B：

* 源端口：源端口号。不需要时可以全0。
* 目的端口：目的端口号。终点交付报文时用到。
* 长度：UDP数据报的长度（包括首部和数据），所以最小长度为8
* 校验和：检测UDP数据报在传输时是否有错。该字段可选，源主机不想校验时令该字段为全0.





### UDP校验







## TCP

### 协议特点

* 面向连接
* 每条TCP连接只能有两个端点，即点对点连接
* TCP提供可靠交付，保证传送的数据无差错、不丢失、不重复且有序
* TCP提供全双工通信，连接的两端都有发送缓存和接收缓存
* TCP是面向字节流的，即把应用程序发送的数据视为一连串的字节流

### TCP报文段

TCP报文既可以运载数据又可以用来建立连接、释放连接和应答。

一个TCP报文段分为首部和数据两部分。首部是固定的20B，最后有4N字节的可选项。

* 源端口和目的端口：各占2B
* 序号：占4B，TCP连接传输的字节流中每个字节都按顺序编号。序号字段指的是本报文段发送的数据的**第一个字节的序号**。
* 确认号：占4B，期望收到**对方下一个报文段的第一个数据字节的序号**。若确认号为N，则表示到序号N-1为止的所有数据都已正确收到
* 数据偏移：占4位，表示首部长度，单位为32位（4B），即例如该字段的值为15时，达到TCP首部的最大长度60B
* 保留：占6位，保留为今后使用，目前应置为0.
* 紧急位URG：URG=1时表示紧急指针字段有效。告诉系统此报文段有紧急数据，相当于高优先级。URG需要和紧急指针配合使用，即从数据第一个字节到紧急指针所指的字节就是紧急数据。
* 确认位ACK：当ACK=1时确认号字段才有效，为0时无效。
* 推送位PSH：接收方TCP收到PSH=1的报文段就尽快交付给应用程序，不再等到整个缓存都填满后再向上交付。
* 复位位（RST）：RST=1时表明TCP连接出现严重差错，必须释放连接，重新建立连接
* 同步位（SYN）：SYN=1时表示这是一个连接请求或连接接收报文。当SYN=1，ACK=0时是一个请求连接报文，对方若同意建立连接，则应在响应报文中使用SYN=1，ACK=1
* 终止位FIN：用来释放一个连接，当FIN=1时表示传输完成，要求释放传输连接
* 窗口：占2B，指出现在允许对方发送的数据量，因为接收方的缓存有限
* 校验和：占2B，该字段的检验范围包括首部和数据两部分。计算检验和时同样要再前面加上12B的伪首部。
* 紧急指针：占2B，指出本报文段中紧急数据共有多少字节。
* 选项：长度可变。TCP最初只规定了一种选项：最大报文段长度（MSS），MSS仅仅指出数据段的最大长度
* 填充：为了使整个首部长度是4B的整数倍

### TCP连接管理

**三次握手建立TCP连接**

* 第一步：客户机的TCP向服务器的TCP发送连接请求报文段。该报文段的同步位**SYN置为1**，同时选择一个初始序号seq=x。SYN报文段不能携带数据，但要消耗掉一个序号。这是客户机进入SYN-SENT同步已发送状态。
* 第二步：服务器的TCP收到连接请求后，如果同意建立连接，则向客户机发回确认，并为该TCP分配缓存和变量。在确认报文段中，**SYN和ACK都置为1**，确认号是ack=x+1，同时为自己选择一个初始序号seq=y。确认报文不能携带数据，但也要消耗一个序号。此时服务器进入SYN-RCVD同步收到状态。
* 第三步：客户机收到确认报文后，还要向服务器给出确认，并为该TCP连接分配缓存和变量。确认报文段的**ACK置为1**，确认号ack=y+1，序号seq=x+1.该报文段可以携带数据，若不携带则不消耗序号。此时TCP客户进程进入ESTABLISH已建立连接状态。

**四次握手释放TCP连接**

* 第一步：客户端TCP发送连接释放报文段，并停止发送数据，终止位**FIN置为1**，序号seq=u，等于之前已经传送的数据的最后一个字节的序号加1，FIN报文段即使不携带数据也要消耗一个序号。此时TCP客户机进入FIN-WAIT-1状态。
* 第二步：服务器收到连接释放报文后即发出确认，确认号ack=u+1，序号seq=v，等于前面已经传输过的数据的最后一个字节的序号加1.然后服务器进入CLOSE-WAIT状态。此时从客户机到服务器的连接就释放了，TCP连接处于半关闭状态。
* 第三步：若服务器已经没有要向客户机发送的数据，就通知TCP释放连接，此时其发出**FIN=1**的连接释放报文段，该报文段的序号为w（在半关闭的时候可能又传输了一些数据），还需重复上次已经发送的确认号ack=u+1.此时服务器进入LAST-ACK状态。
* 第四步：客户机收到连接释放报文段后，要发送确认。把确认报文中的**确认位ACK置为1**，确认号ack=w+1，序号seq=u+1。此时连接还未释放，要等到计时器的设置时间2MSL（最长报文寿命）后客户机才进入CLOSED状态。

### TCP可靠传输

**序号**

序号字段用来保证数据能有序提交给应用层。序号建立在字节流之上。

**确认**

TCP首部的确认号是期望收到对方的下一个数据段的数据的第一个字节的序号。

发送缓冲区会继续存储那些已经发送但未收到的确认报文段，以便在需要时重传。

TCP默认使用累计确认，即TCP只确认数据流中至第一个丢失字节为止的字节。

**重传**

发生超时和冗余ACK时会导致重传。

* 超时：TCP没发送一个报文段，就对该报文段设置一次计时器，如果计时器设置的时间到期还未收到确认，就重传这一报文段。TCP采用一种自适应算法来计算超时重传时间，TCP保留一个往返时间RTT的加权平均值，会随着新测量RTT样本值的变化而变化。重传时间应略大于这个加权平均值。
* 冗余ACK：超时重传存在一个问题是超时周期往往太长。发送方通常可以在超时时间发生之前通过冗余ACK检测丢包情况。冗余ACK就是再次确认某个报文段的ACK，发送方先前已经受到过该报文段的确认。当比期望序号大的失序报文段到达时，就发送一个冗余ACK，指明下一个期待字节的序号。TCP规定当发送方收到对同一个报文段的**3个冗余ACK**时，就认为跟在这个被确认报文段后的报文段**已经丢失**。

### TCP流量控制

TCP提供流量控制服务来消除发送方（发送速率太快）使得接收方缓存区溢出的可能性。是一个速度匹配服务。

TCP提供一种基于滑动窗口协议的流量控制机制。

接收方根据自己接收缓存的大小，动态调整发送方的发送窗口大小，称为**接收窗口rwnd**。即调整TCP报文段首部中窗口字段的值来限制发送方向网络注入报文的速率。同时发送方根据当前网络拥塞程度的估计而却认定窗口值，称为**拥塞窗口cwnd**。

发送窗口的实际大小取rwnd和cwnd中较小的一个。

传输层和数据链路层流量控制的区别：传输层定义端到端用户之间的流量控制，数据链路层定义两个中间的相邻结点的流量控制。数据链路层的滑动窗口大小不能动态变化，而传输层可以。

### TCP拥塞控制

拥塞控制是让**网络能够承受现有网络负荷**，是一个全局性的过程，涉及所有主机、路由器。流量控制指点到点的通信量的控制，是一个**端到端**的问题，它所做的是抑制发送端发送数据的速率，以便使得接收端来得及接收。

因特网标准定义了进行拥塞控制的4种方法：慢开始、拥塞避免、快重传和快恢复。

发送方既要考虑接收方的接收能力，又要考虑全局网络的拥塞程度，因此TCP协议要求发送方维护两个窗口：

* 接收窗口rwnd：接收方根据目前接收缓存的大小所许诺的最新窗口值，反映接收方的容量。由接收方根据其放在TCP首部窗口字段通知发送方。
* 拥塞窗口cwnd：发送饭根据自己估算的网络拥塞程度而设置的窗口值，反映当前网络的容量。

发送窗口的上限值应该取以上两者中较小的一个。

**慢开始算法**

TCP刚建立好连接并开始发送报文段时，先令拥塞窗口cwnd=1，即一个最大报文段长度MSS。每收到**一个对新报文段的确认**后，将cwnd增加1.用这样的方法逐步增大发送方的cwnd，使得分组注入网络的速率更加合理。

此时拥塞窗口cwnd呈指数式增长，直到增大到一个规定的慢开始门限ssthresh（阈值），然后改用拥塞避免算法。

**拥塞避免算法**

拥塞避免算法让拥塞窗口cwnd缓慢增加，没经过一个往返时延RTT就把发送方的拥塞窗口cwnd加1，使得拥塞窗口按线性规律增加。这比满开始算法的增长速率慢得多。

**网络拥塞处理**

无论在慢开始阶段还是拥塞避免阶段，只要发送方判断网络出现拥塞，就要把慢开始门限ssthresh设置为出现拥塞时的发送方的cwnd值的一半（不能小于2）。然后把拥塞窗口cwnd重新设置为1，执行慢开始算法。

这样能够迅速减少主机发送到网络中的分组数，使得发生拥塞的路由器有足够时间把队列中积压的分组处理完。

窗口数量变化图见书上P223

**快重传**

是对以上的慢开始和拥塞避免算法的改进。

前面可靠传输中介绍的冗余ACK也用于网络拥塞的检测。当发送方连续收到3个重复的ACK报文时，直接重传对方尚未收到的报文段，不必等待那个报文段设置的重传计时器超时。

**快恢复**

与慢开始不同的是，发生拥塞后，把ssthresh值设置为此时发生方cwnd的一般，然后把cwnd值设置为慢开始门限ssthresh改变后的数值，然后执行拥塞避免（加法增大）算法。

