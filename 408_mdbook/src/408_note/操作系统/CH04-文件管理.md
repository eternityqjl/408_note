## 文件系统基础

### 文件的概念

**文件的定义**

系统运行时，计算机以进程为单位进行资源的调度和分配。用户进行的输入、输出中，以文件为基本单位。

操作系统的文件系统用来管理和维护文件。

文件的结构化表述：

* 数据项：文件系统中给最低级的数据组织形式，分为：
  * 基本数据项：用于描述一个对象的某种属性的一个值
  * 组合数据项：多个基本数据项的集合
* 记录：一组相关的数据项的集合，用于描述一个对象在某方面的属性
* 文件：创作者定义的一组相关信息的集合，分为：
  * 有结构文件（记录式文件）
  * 无结构文件（流式文件）

文件可以是数字、字母或二进制代码，基本访问单元可以是字节、行或记录。

**文件的属性**

* 名称：文件名称唯一
* 标识符：标识文件系统内文件的唯一标签，通常为数字
* 类型
* 位置
* 大小
* 保护
* 时间、日期和用户标识

所有文件信息都保存在**目录结构**中，而目录结构保存在**外存**中。

**文件的基本操作**

文件属于抽象数据类型，操作系统提供系统调用，对文件进行以下操作：

* 创建文件：创建空间+创建条目
* 写文件
* 读文件
* 文件重定位（文件寻址）
* 删除文件
* 截断文件

**文件的打开与关闭**

许多系统要求在首次使用文件时，使用系统调用open将指明文件属性（包括文件在外存上的物理位置）从外存复制到**内存**打开文件表的一个表目中，并将该标目的编号（索引）返回给用户。系统维护一个包含所有打开文件信息的表——**打开文件表**。当用户需要一个文件操作时，可通过该表的一个**索引**指定文件，省略了搜索环节。文件不再使用时，进程可以关闭它，操作系统从打开文件表中删除这个条目。

大部分操作系统要求在文件使用前就被显示地打开。操作open会**根据文件名搜索目录**，并将该**目录条目**复制到打开文件表。若调用open的请求（创建、只读、读写、添加等）得到允许，则进程可以打开文件。open通常返回一个指向打开文件表中的一个条目的**指针**，通过使用该指针进行I/O操作，来简化步骤并节省资源。

每个打开文件都有如下关联信息：

* 文件指针
* 文件打开计数：多个进程可能打开同一个文件，系统在删除打开文件前，必须等待最后一个进程关闭文件。计数为0时，系统关闭文件，删除该条目。
* 文件磁盘位置
* 访问权限

### 文件的逻辑结构

文件的逻辑结构是从**用户角度**看文件的组织形式，**与存储介质的特性无关**，实际上是指在文件的内部，数据逻辑上是如何组织起来的。文件的物理结构是从实现观点出发看到的文件在外存上的存储组织形式。

按逻辑结构，文件可划分为有结构和无结构文件两种。

**无结构文件（流式文件）**

将数据按顺序组织成记录并积累、保存，它是有序相关信息项的集合，以字节为单位。无结构文件没有结构，因而对记录的访问只能通过**穷举搜索**的方式，这种文件形式对大多数应用不适用。对基本信息单位操作不多的文件较适于采用字符流的无结构方式，如源程序文件、目标代码文件。

**有结构文件（记录式文件）**

* **顺序文件**：文件中的**记录一个接一个地顺序排列**，记录通常是定长的，可以顺序存储或以链表的形式存储，在方式时要顺序搜索文件。顺序文件有以下两种结构：

  * 串排列：记录之间的顺序与关键字无关。通常由时间决定顺序。
  * 顺序结构：文件中的所有记录按关键字排序。

  大批量读写时，顺序文件的效率最高；但顺序文件对查找、修改、增加删除等操作较为困难。

* **索引文件**：按照定长和变长文件分。通过公式计算**每条记录**的地址。可以为变长记录文件建立一张索引表，来加快检索速度。索引表本身是定长记录的顺序文件。

* **索引顺序文件**：顺序和索引两种组织形式的结合。将顺序文件的**所有记录分为若干组**，为顺序文件建立一个索引表，在索引表中为**每组的第一条记录**建立一个索引项，其中含有该记录的**关键字值**和指向该记录的**指针**。**组与组之间的关键字有序**，但同一组中的关键字可以无序。查找一条记录时，首先通过索引表找到其所在的组，然后在该组中使用顺序查找。

  采用这种方式能够加快查找速率。

* **直接文件或散列文件（Hash File）**：由给定记录的键值或散列函数转换的键值直接决定记录的物理地址。这种方式有很高的读取速度，但存在冲突。

### 目录结构

文件目录包含有关文件的信息如属性、位置和所有权等，由操作系统进行管理。目录提供**文件名和文件之间的一种映射**。这实际上是解决多个文件之间在逻辑上如何组织的问题，是文件的外部逻辑问题。

**文件控制块FCB和索引节点**

与进程一样，为了方便管理，操作系统引入文件控制块FCB的数据结构。

* 文件控制块：存放控制文件所需的各种信息，以实现按名存取。**FCB的有序集合**称为**文件目录**，一个FCB就是一个文件目录项。FCB主要包括以下信息：
  * 基本信息：文件名、物理位置、逻辑结构等
  * 存取控制信息：文件存取权限等
  * 使用信息：文件建立时间、修改时间等
* 索引结点：检索目录时，只用到了文件名，其他描述信息用不到。因此有的系统采用文件名和文件描述信息分开的方法，文件描述信息单独形成一个称为索引结点的数据结构，简称i结点。

存放在磁盘上的索引结点称为**磁盘索引结点**，UNIX中的每个文件都有一个唯一的磁盘索引结点，主要包括：

* 文件主标识符
* 文件类型
* 文件存取权限
* 文件物理地址
* 文件长度
* 文件链接计数
* 文件存取时间

文件被打开时，磁盘索引结点复制到内存的索引结点中，便于使用。内存索引结点增加了以下内容：

* 索引结点编号
* 状态
* 访问计数
* 逻辑设备号
* 链接指针

**目录结构**

目录这个层次上所要执行的操作：

* 搜索
* 创建文件
* 删除文件
* 显示目录
* 修改目录

考虑以下几种目录结构：

* 单级目录结构：整个文件系统只建立一张目录表，每个文件占一个目录项。实现了按名存取，但查找速度慢、文件不允许重名、不便于文件共享，对于多用户操作不适用。

* 两级目录结构：将文件目录分为**主文件目录**和**用户文件目录**两级。能解决多用户之间的文件重名问题，文件系统可以在目录上实现访问限制。但缺乏灵活性，不能对文件分类。

* 多级目录结构（树形结构）：将两级目录结构的层次关系加以推广即可。

* 无环图目录结构：在树形目录结构的基础上增加了一些指向同一结点的有向边，使整个目录成为一个有向无环图。引入无环图目录结构是为了实现**文件共享**。

### 文件共享

文件共享使多个用户（进程）共享同一个文件，系统中只需要保留该文件的一个副本。

现代常用的两种文件共享方法：

**基于索引结点的共享方式（硬链接）**



**利用符号链实现文件共享（软链接）**



硬链接就是多个指针指向一个索引结点，保证只要还有一个指针指向索引结点，索引结点就不能被删除；软链接就是把到达共享文件的路径记录下来，当要访问文件时，根据路径寻找文件。

### 文件保护

为了防止文件共享可能会导致文件被破坏或未经核准的用户修改文件，文件系统要控制用户对文件的存取。即解决对文件的读、写、执行的许可问题。

文件保护通过口令保护、加密保护和访问控制等方式实现。前两者是为了防止用户文件被他人存取或窃取，后一个是用于控制用户对文件的访问方式。

**访问类型**

* 读
* 写
* 执行
* 添加
* 删除
* 列标清单

保护可以只在低层提供。

**访问控制**

根据用户身份进行控制。为每个文件和目录增加一个访问控制列表ACL，规定每个用户名及其所允许的访问类型。

精简的访问列表：

* 拥有者
* 组
* 其他

## 文件系统实现

文件物理结构和目录的实现。

### 文件系统层次结构

现代操作系统有多种文件系统类型，文件系统的层次结构也不尽相同。

**用户调用接口**

操作系统为用户提供的与文件及目录有关的调用。此层由若干程序模块组成，每个模块对应一条系统调用。

**文件目录系统**

用来管理文件目录。

**存取控制验证模块**

实现文件保护。

**逻辑文件系统与文件信息缓冲区**

将用户要读写的逻辑记录转换成文件逻辑结构内的相应块号。

**物理文件系统**

把逻辑记录所在的相应块号转换成实际的物理地址。

**辅助分配模块**

管理辅助存储空间，及负责分配辅存空闲空间和回收辅存空间。

**设备管理程序模块**

主要功能是分配设备、分配设备读写缓存区、磁盘调度、启动设备、处理设备中断、释放设备读写缓存、释放设备。





### 目录实现

目录项中提供了查找文件磁盘块所需的信息。目录的实现就是为了**查找**。基本实现方式有线性列表和哈希表两种。

**线性列表**

使用存储**文件名**和**数据块指针**的线性表。

创建文件时，必须首先搜索目录表以确定没有同名的文件存在，然后在目录表后增加一个目录项。删除文件则根据给定文件名搜索目录表，然后释放空间。

采用链表结构可以减小删除文件时间。

**哈希表**

根据文件名得到一个值，并返回一个指向线性列表中元素的指针。这种方法查找非常迅速，插入和删除也较简单，但需要一些预备措施来避免冲突。

目录查询是通过在磁盘上反复搜索完成的，需要大量I/O操作。为了减少I/O操作，把当前使用的文件目录复制到内存，降低了磁盘操作次数，提高了系统速度。

### 文件实现——文件分配方式

文件的实现就是研究**文件的物理结构**，即文件数据在物理存储设备上如何分布和组织。文件分配方式指的是对**磁盘非空闲块**的管理；文件存储空间管理是对**磁盘空闲块**的管理。

文件分配是指如何为文件分配磁盘块。常用的有以下三种。一般情况下一种系统只支持一种方法。

**连续分配**

每个文件在磁盘上占有一组连续的块。磁盘地址定义了一个线性序列。这种排序使作业访问磁盘时需要的寻道数和寻道时间最少。

文件的连续分配可以用第一块的磁盘地址和连续块的数量来定义。

连续分配支持顺序访问和直接访问，优点是实现简单，存取速度快。缺点是文件长度不宜动态增加。

**链接分配**

采取离散分配方式，消除了外部碎片，显著提高了磁盘空间的利用率。文件动态增长时，可以动态地为其分配盘块，无须事先知道文件的大小，对文件的增、删、改也非常方便。链接分配分为隐式链接和显式链接。

（1）隐式链接

每个文件对应一个磁盘块的链表；磁盘块分布在任何地方，除最后一个盘块外，每个盘块都有指向下一个盘块的指针，这些指针对用户是透明的。目录包括文件的第一个指针和最后一个指针。

创建新文件时，目录中增加一个新条目。每个目录项都有一个指向文件首块的指针。该指针初始化为NULL表示空文件，大小字段为0。写文件通过空闲管理系统找到空闲块，将该块链接到文件的尾部，以便写入。读文件通过块到块的指针顺序读块。

隐式链接的缺点是无法直接访问盘块，且盘块指针会消耗一定的存储空间。指针还有可能丢失或损坏，导致文件数据丢失。

（2）显式链接

把用于连接文件各物理块的指针，从每个物理块的块末尾提取出来，显示地存放在内存的一张链表中。该表在整个磁盘中仅设置一张，称为**文件分配表FAT**。每个表项中存放对应块的下一块连接指针，即下一个盘块号。文件的第一个盘块号记录在目录中，后续盘块号通过FAT表查找。

FAT的表项与全部磁盘块一一对应，用特殊数字-1表示文件的最后一块，用-2表示这个磁盘块是空闲的。

FAT表在系统启动时就会被读入内存，因此查找的过程是在内存中进行的，既能提高检索速度，还能减少磁盘访问次数。

**索引分配**

索引分配支持直接访问。它把每个文件的所有盘块号都集中放在一起构成索引块（表）。

每个文件都有其索引块，这是一个磁盘块地址的数据。索引块的第i个条目指向文件的第i个块。文件的目录条目包括索引块的地址。

创建文件时，索引块的所有指针都设为空，首次写入第i块时，先从空闲块中取得一个块，再将其地址写入索引块的第i个条目。索引分配支持直接访问，且没有外部碎片问题。缺点是索引块增加了系统存储空间的开销。可以采用以下机制控制索引块的大小：

* 链接方案
* 多层索引
* 混合索引





### 文件实现——文件存储空间管理

**文件存储器的划分与初始化**

一个文件存储在一个文件卷中。文件卷可以是物理盘的一部分也可以是整个物理盘。

一个文件卷中，文件数据信息空间（文件区）和文件控制信息空间（目录区）是分离的。由于存在多种文件表示和存放格式，现代操作系统中一般有很多不同的文件管理模块。逻辑卷在提供文件服务前，必须由对应的文件程序进行初始化，划分好目录区和文件区，建立空闲空间管理表格和存放逻辑卷信息的超级块。

**文件存储器空间管理**

文件存储设备分成许多大小相同的物理块，以块为单位交换信息，因此文件存储设备实际上是对空闲块的组织和管理，包括空闲块的组织、分配与回收。

* 空闲表法

属于连续分配方式，与内存的动态分配类似。为每个文件分配一块连续的存储空间。

系统为外存上所有空闲区建立一张空闲盘块表，每个空闲区对应于一个空闲表项其中包含表项序号、该空闲区第一个盘块号、该区的空闲盘块数等信息。再将所有空闲区按其起始盘块号递增的次序排列。

空闲盘区的分配与内存的动态分配类似，同样采用首次适应算法、循环首次适应算法等。

系统对用户释放的存储空间进行回收时，也采取类似于内存回收的方法。

* 空闲链表法：将所有空闲盘区拉成一条空闲链，根据构成链所用的基本元素不同，可以分为：
  * 空闲盘块链：所有空闲空间以盘块为单位拉成一条链。用户请求分配存储空间时，系统从链首开始，依次摘下适当数目的空闲盘块分配给用户。用户释放存储空间是，系统将回收的盘块依次插入空闲盘块链的末尾。
  * 空闲盘区链：将所有空闲盘区（每个盘区可包含若干盘块）拉成一条链。每个盘区上除了含有用于指示下一个空闲盘区的指针外，还应有能指明本盘区大小的信息。分配盘区方法与内存动态分配类似。采用首次适应法。

* 位示图法：用二进制的一位表示磁盘中一块的使用情况，磁盘上的所有盘块都有一个二进制位与之对应。当值为0时表示对应盘块空闲；当值为1时表示对应盘块已分配。盘块的分配方法为：

  * 顺序扫描位示图，从中找出一个或一组值为0的二进制位。

  * 将找到的一个或一组二进制位转换为与之对应的盘块号。若找到的值为0的二进制位位于位示图的第i行、第j列，则其相应的盘块号应按下列公式计算：
    $$
    b=n(i-1)+j
    $$

  * 修改位示图，令$\text{map}[i,j]=1$

盘块的回收同理，将盘块号转换为位示图的行和列，然后修改位示图。

* 成组链接法

UNIX系统采用了这种方法，结合了空闲表和空闲链表两种方法，克服了表太大的缺点。思想为：把顺序的n个空闲扇区地址保存在第一个空闲扇区（这n个中的第一个）内，其最后一个空闲扇区（这n个中的最后一个）内则保存另一组顺序空闲扇区的地址。系统只需要保存一个指向第一个空闲扇区的指针。这种方式可以迅速找到大批空闲块地址。

## 磁盘组织与管理

### 磁盘的结构

磁头、磁道、扇区（每个512B，又称为盘块）。

磁盘安装在一个磁盘驱动器中，由磁头臂、主轴和其他电子设备组成。多个盘片垂直堆叠，组成磁盘组，每个盘面对应一个磁头，所有磁头固定在一起，与磁盘中心的距离相同且一起移动。所有盘片上相对位置相同的磁道组成**柱面**。

按照这种物理结构组织，扇区就是磁盘可寻址的最小存储单位，磁盘地址用**柱面号·盘面号·扇区号**表示。

磁盘可分为：固定磁头磁盘、活动头磁盘、固定盘磁盘、可换盘磁盘。

### 磁盘调度算法

一次磁盘读写操作的时间由寻道时间、旋转延迟时间和传输时间决定。

* 寻找时间：读写信息前将磁头移动到指定磁道所需的时间。
* 旋转延迟时间：磁头定位到某一磁道的扇区所需的时间。
* 传输时间：从磁盘读出或向磁盘写入数据所经历的时间。

在实际的磁盘I/O中，存取时间与磁盘调度算法密切相关。调度算法直接决定寻找时间，从而决定总的存取时间。

常用的磁盘调度算法：

**先来先服务算法FCFS**

根据进程请求访问磁盘的先后顺序进行调度。该算法具有公平性。但若有大量进程竞争使用磁盘，这种算法在性能上接近于随即调度。

**最短寻找时间优先算法SSTF**

该算法选择调度处理的磁道是与当前磁头所在磁道距离最近的磁道，以便每次寻找时间最短。这种算法可能会产生饥饿现象，即距离较远的磁盘的访问可能被无限延期。

**扫描算法SCAN**

该算法在磁头**当前移动方向上**选择与当前磁头所在磁道距离最近的请求作为下一次服务的对象。实际上就是规定了磁头运动方向的最短寻找时间优先算法。这个算法对最近扫描过的区域不公平，在访问局部性方面不如上两个算法。

**循环扫描算法C-SCAN**

在扫描算法的基础上规定磁头单向移动来提供服务，回返时直接快速移动至起始段而不服务任何请求。



另外减少延迟时间也能提高磁盘传输效率。可以对盘面扇区进行交替编号，对磁盘片组中的不同盘面错位命名。

### 磁盘的管理

**磁盘初始化**

磁盘进行存储数据之前，必须分成扇区以便磁盘控制器能进行读和写操作，这个过程称为低级格式化（物理分区）。低级格式化为磁盘的每个扇区采用了特别的数据结构。每个扇区的数据由头、数据区域（512B）和尾部组成。头部和尾部包含了一些磁盘控制器所使用的信息。

为了使用磁盘存储文件，操作系统还需要要将自己的数据结构记录在磁盘上：第一步将磁盘分为由一个或多个柱面组成的分区；第二部对物理分区进行逻辑格式化（创建文件系统），操作系统将初始的文件系统数据结构存储到磁盘上，这些数据结构包括空闲和已分配的空间及一个初始为空的目录。

**引导块**

计算机启动时需要运行一个初始化程序（自举程序），它初始化各种硬件和操作系统。该操作系统找到磁盘上的操作系统内核，装入内存并转到起始地址，而从开始运行。

**坏块**

磁盘可能有一个或多个扇区损坏。

对于简单磁盘，坏扇区可以手工处理。系统可以在执行逻辑格式化的时候扫描磁盘以检查坏扇区。坏扇区会在FAT表上表明，程序不会使用。

对于复杂磁盘，其控制器维护一个磁盘坏块链表。该链表在出厂前进行低级格式化时就已经初始化，并在磁盘整个使用过程中不断更新。控制器可以用备用块来逻辑替代坏块，称为扇区备用。



