## I/O管理概述

### I/O设备

I/O设备按照**使用特性**可以分为以下类型：

* 人机交互类外部设备
* 存储设备
* 网络通信设备

按照**传输速率**可分为：低速、中速、高速设备

按信**息交换类型**的单位分为：块设备、字符设备

### I/O控制方式

程序直接控制方式、中断驱动方式、DMA方式、通道控制方式。

该部分内容详见组成原理部分。

I/O通道控制方式时DMA方式的发展，可以进一步减少CPU的干预，还可以实现CPU、通道和I/O设备三者的并行操作，从而更有效地提高整个系统的资源利用率。

### I/O子系统的层次结构

整个I/O系统可以视为具有4个层次的系统结构，各层次及其功能如下：

**用户层I/O软件**

实现**与用户交互的接口**，用户可以直接调用在用户层提供的、与I/O操作有关的函数，对设备进行操作。

**设备独立性软件**

用于实现用户程序与设备驱动器的统一接口、设备命令、设备保护以及设备的分配与释放。

设备独立性也称设备无关性，使得应用程序独立于具体使用的物理设备。为实现独立性而引入**逻辑设备**和**物理设备**这两个概念。

应用程序中，使用**逻辑设备名**来请求使用某类设备；系统实际执行时，必须将逻辑设备名**映射**成物理设备名使用。

设备独立心性软件的主要功能可以分为：

* 执行所有设备的公有操作。
* 向用户层（或文件曾）提供统一接口。

**设备驱动程序**

与硬件直接相关，负责具体实现系统对设备发出的操作指令，驱动I/O设备工作的驱动程序。

**中断处理程序**

用于保存被中断进程的CPU环境，转入相应的中断处理程序进行处理，处理完并恢复被中断进程的现场后，返回到被中断进程。

**硬件设备**

包括一个机械部件（**设备本身**）和一个电子部件（又称**适配器**或设备控制器，即一块插入主板的印刷电路板）

适配器的主要功能：

* 接收和识别CPU或通道发来的命令
* 实现数据交换
* 发现和记录设备自身的状态信息，供CPU处理使用。
* 设备地址识别

为了实现以上功能，设备控制器必须包含以下组成部分：

* 设备控制器与CPU的接口。
* 设备控制器与设备的接口
* I/O控制逻辑

![设备控制器](https://raw.githubusercontent.com/eternityqjl/blogGallery/master/%E8%AE%BE%E5%A4%87%E6%8E%A7%E5%88%B6%E5%99%A8.jpg)

## I/O核心子系统

### 概述

I/O设备种类繁多，功能、速度差异大，需要**多种方法**来进行设备控制。这些方法共同组成了**操作系统内核的I/O子系统**，它将内核的其他方面从繁重的I/O设备管理中解放出来。该子系统主要有I/O调度、缓冲与高速缓存

### I/O调度概念

确定一个**好的顺序**来执行这些I/O请求。应用程序发布的系统调用顺序不一定是最佳选择，需要I/O调度来改善系统整体性能，使进程之间公平地共享设备访问，减少I/O完成所需要的平均等待时间。

操作系统为**每个设备**维护一个**请求队列**来实现调度。当一个应用程序执行阻塞I/O系统时，该请求就加到相应设备的队列上。I/O调度会重新安排队列顺序以改善系统总体效率和应用程序的平均响应时间。

### 高速缓存与缓冲区

**磁盘高速缓存**

利用内存中的存储空间来暂存从磁盘中读出的一系列盘块中的信息。**逻辑上**属于**磁盘**，**物理上**则驻留在**内存**中的盘块。

高速缓存在内存中分为两种形式：一种是在内存中**单独开辟一个存储空间**作为磁盘高速缓存，大小固定；另一种是把**未利用的内存空间**作为一个**缓冲池**，供请求分页系统和磁盘I/O时共享。

**缓冲区Buffer**

设备管理子系统引入缓冲区的主要目的是：

* 缓和CPU与I/O设备间速度不匹配的矛盾
* 减少对CPU的中断频率，放宽对CPU中断响应时间的限制
* 解决基本数据单元大小（数据粒度）不匹配的问题
* 提高CPU和I/O设备之间的并行性

实现方法为：

* 采用硬件缓冲器，成本较高
* 采用缓冲区（位于内存区域）

根据系统设置缓冲器的个数，缓冲技术可以分为：

* 单缓冲
* 双缓冲：提高了处理机和输入设备的并行操作的程度
* 循环缓冲：包含多个大小相等的缓冲区，每个缓冲区中有一个链接指针指向下一个缓冲区，最后一个缓冲区指向第一个缓冲区，多个缓冲区构成一个环形。
* 缓冲池：由多个系统公用的缓冲区组成，缓冲区按其使用状况可形成三个队列：空缓冲队列、装满输入数据的缓冲队列、装满输出数据的缓冲队列。另外还应具有4中缓冲区：用于收容输入数据的工作缓冲区、用于提取输入数据的工作缓冲区、用于收容输出数据的工作缓冲区以及用于提取输出数据的工作缓冲区。

### 设备分配与回收

**设备分配概述**

根据用户的I/O请求分配所需的设备，分配的总原则是充分发挥设备的使用效率。

* 独占式使用设备
* 分时式共享使用设备
* 以SPOOLing方式使用外部设备。该技术实质上是一种以空间换时间的技术。

**设备分配的数据结构**

* 设备控制表DCT：表征一个设备，这个控制表中的表项就是设备的各个属性。
* 系统设备表SDT：整个系统只有一张SDT，其记录已连接到系统中的所有物理设备的情况。

**设备分配的策略**

* 设备分配总原则：既要充分发挥设备的使用效率，又要避免造成进程死锁，还要将用户程序和具体设备隔离开。
* 设备分配方式
  * 静态分配：主要用于对独占设备的分配。这种方式不会出现死锁，但设备的使用率低。
  * 动态分配：在进程执行过程中根据执行需要进行。有利于提高设备利用率，但若分配算法使用不当，可能造成死锁。
* 设备分配算法
  * 先请求先分配
  * 优先级高者优先

**设备分配的安全性**

指的是设备分配中应该防止发生进程死锁。

* 安全分配方式。每当进程发出I/O请求后便进入阻塞态，直到其I/O操作完成时才被唤醒。
* 不安全分配方式。

**逻辑设备名到物理设备名的映射**







### 假脱机技术SPOOLing

为了缓和CPU的高速性与I/O设备低速性之间的矛盾，引入了脱机输入/输出技术。该技术利用专门的外围控制机，将低速I/O设备上的数据传送到高速磁盘上，或者相反。是操作系统中采用的一项将独占设备改造成共享设备的技术。

**输入井和输出井**

是指在磁盘上开辟出的两个存储区域。二者用于模拟脱机输入/输出时的磁盘。

**输入缓冲区和输出缓冲区**

是在内存中开辟的两个缓冲区。输入缓冲区用于暂存由输入设备送来的数据，以后再传送到输入经。输出缓冲区用于暂存从输出井送来的数据，以后再传送到输出设备。

**输入进程和输出进程**

















